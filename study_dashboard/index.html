<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORTEX v5.1 | NEURO-LEARNING 3D</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-deep: #020617;
            --text-primary: #F8FAFC;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
            perspective: 1000px;
        }

        #network {
            width: 100vw;
            height: 100vh;
            background: radial-gradient(ellipse at bottom, #1E293B 0%, #020617 80%);
            transform-style: preserve-3d;
        }

        .hud {
            position: absolute;
            top: 30px;
            left: 30px;
            z-index: 100;
            background: rgba(15, 23, 42, 0.7);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #86EFAC;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            min-width: 280px;
            transform: translateZ(50px);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        h2 {
            margin: 0 0 15px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            color: #86EFAC;
            letter-spacing: 0.05em;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            text-align: center;
        }

        .stat-val {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #94A3B8;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            z-index: 200;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
        }

        button.option-btn {
            display: block;
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
            border: 1px solid #334155;
            padding: 18px;
            margin-bottom: 12px;
            text-align: left;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        button.option-btn:hover {
            background: linear-gradient(90deg, rgba(253, 186, 116, 0.1) 0%, transparent 100%);
            border-color: #FDBA74;
            transform: translateX(8px);
        }

        /* Typing Input Styles */
        .typing-container {
            margin-top: 30px;
            position: relative;
        }

        .typing-input {
            width: 100%;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #334155;
            border-radius: 12px;
            color: #86EFAC;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .typing-input:focus {
            border-color: #86EFAC;
            box-shadow: 0 0 20px rgba(134, 239, 172, 0.1);
        }

        .typing-hint {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #64748B;
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>

<body>

    <div class="hud">
        <h2>CORTEX SYSTEM</h2>

        <div class="stat-grid">
            <div class="stat-box">
                <span id="topic-count" class="stat-val" style="color:#86EFAC">0</span>
                <span class="stat-label">TEMAS</span>
            </div>
            <div class="stat-box">
                <span id="variant-count" class="stat-val" style="color:#C4B5FD">0</span>
                <span class="stat-label">VARIANTES</span>
            </div>
            <div class="stat-box" style="grid-column: span 2; margin-top:10px;">
                <span id="total-questions" class="stat-val" style="color:#FDBA74">0</span>
                <span class="stat-label">PREGUNTAS TOTALES</span>
            </div>
        </div>

        <hr style="border-color:rgba(255,255,255,0.1); margin:15px 0;">

        <div style="font-size:0.75rem; color:#64748B; margin-bottom: 5px;">MAESTR√çA ACTUAL</div>
        <div id="current-obj" style="color:#F1F5F9; font-size:0.9rem; font-weight:600; line-height:1.4;">
            Sincronizando...
        </div>
    </div>

    <div id="network"></div>

    <div id="study-modal" class="modal">
        <div id="modal-content"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const COLORS = {
            SAGE: { fill: 'rgba(134, 239, 172, 0.2)', border: '#86EFAC', glow: 50 },
            PEACH: { fill: 'rgba(253, 186, 116, 0.3)', border: '#FDBA74', glow: 80 },
            LAVENDER: { fill: 'rgba(196, 181, 253, 0.25)', border: '#C4B5FD', glow: 60 },
            LOCKED: { fill: 'rgba(51, 65, 85, 0.3)', border: '#475569', glow: 0 }
        };

        let nodesDataset = new vis.DataSet();
        let edgesDataset = new vis.DataSet();
        let network = null;

        function initGraph() {
            const container = document.getElementById('network');
            const data = { nodes: nodesDataset, edges: edgesDataset };

            const options = {
                nodes: {
                    shape: 'dot',
                    borderWidth: 2,
                    font: { size: 14, color: '#E2E8F0', face: 'Inter', multi: true },
                    scaling: { min: 20, max: 40 }
                },
                edges: {
                    width: 1,
                    color: { color: 'rgba(71, 85, 105, 0.4)', highlight: '#C4B5FD' },
                    smooth: { type: 'continuous', roundness: 0.5 }
                },
                physics: {
                    stabilization: false,
                    barnesHut: {
                        gravitationalConstant: -25000,
                        springConstant: 0.03,
                        springLength: 300,
                        avoidOverlap: 1
                    }
                },
                interaction: { hover: true, tooltipDelay: 200 }
            };

            network = new vis.Network(container, data, options);

            network.on("click", params => {
                if (params.nodes.length) handleNodeClick(nodesDataset.get(params.nodes[0]));
            });

            loadData();
            setInterval(loadData, 3000);
        }

        async function loadData() {
            try {
                const res = await fetch('/graph_data');
                const graph = await res.json();

                const mastered = graph.nodes.filter(n => n.group === 'mastered');
                const reviews = graph.nodes.filter(n => n.id >= 90);
                const baseTopics = mastered.length - reviews.filter(n => n.group === 'mastered').length;

                document.getElementById('topic-count').innerText = baseTopics;
                document.getElementById('variant-count').innerText = reviews.length;
                document.getElementById('total-questions').innerText = mastered.length;

                // FIBONACCI SPIRAL LAYOUT ENGINE
                // Golden Angle = 137.508 degrees (approx 2.4 radians)
                const GOLDEN_ANGLE = Math.PI * (3 - Math.sqrt(5));
                const SCALING = 180; // Space between nodes

                graph.nodes.forEach((n, index) => {
                    let style = COLORS.LOCKED;
                    let size = 25;

                    if (n.group === 'mastered') style = COLORS.SAGE;
                    if (n.group === 'active') {
                        style = COLORS.PEACH; size = 45;
                        document.getElementById('current-obj').innerText = n.label.replace('\n', ' ');
                    }
                    if (n.group === 'review') { style = COLORS.LAVENDER; size = 35; }

                    // Calculate Fibonacci Position
                    // r = c * sqrt(n)
                    // theta = n * golden_angle
                    const i = index + 1;
                    const radius = SCALING * Math.sqrt(i);
                    const theta = i * GOLDEN_ANGLE;

                    const x = radius * Math.cos(theta);
                    const y = radius * Math.sin(theta);

                    nodesDataset.update({
                        id: n.id,
                        label: n.group === 'active' ? `<b>${n.label}</b>` : n.label,
                        x: x, // Lock Position X (Fibonacci)
                        y: y, // Lock Position Y (Fibonacci)
                        color: {
                            background: style.fill,
                            border: style.border,
                            highlight: { background: style.fill, border: '#FFF' }
                        },
                        shadow: {
                            enabled: true,
                            color: style.border,
                            size: style.glow,
                            x: 0, y: 0
                        },
                        size: size,
                        group: n.group,
                        title: n.title,
                        physics: false // DISABLE PHYSICS TO KEEP GEOMETRY
                    });
                });

                if (edgesDataset.length === 0) {
                    // 1. Standard Edges (Prerequisites)
                    edgesDataset.add(graph.edges);

                    // 2. THE GOLDEN THREAD (Visual Spiral)
                    // Connects nodes sequentially (1->2->3...) to show the Fibonacci path
                    const spiralEdges = [];
                    // Sort nodes by ID to ensure sequence
                    const sortedNodes = graph.nodes.slice().sort((a, b) => a.id - b.id);

                    for (let i = 0; i < sortedNodes.length - 1; i++) {
                        // Skip if special nodes (Reviews > 90) to keep spiral clean
                        if (sortedNodes[i].id >= 90 || sortedNodes[i + 1].id >= 90) continue;

                        spiralEdges.push({
                            from: sortedNodes[i].id,
                            to: sortedNodes[i + 1].id,
                            color: { color: 'rgba(253, 186, 116, 0.2)', highlight: '#FDBA74' }, // Faint Peach
                            dashes: [5, 15], // Dotted Line
                            width: 1,
                            smooth: { type: 'curvedCW', roundness: 0.2 }
                        });
                    }
                    edgesDataset.add(spiralEdges);
                }

            } catch (e) { console.error(e); }
        }

        async function handleNodeClick(node) {
            if (node.group === 'locked') return;
            if (node.group === 'mastered') {
                // Could open a history view here
                return;
            }

            const res = await fetch('/current_session.json');
            const data = await res.json();

            let html = `<h3 style="color:${node.group === 'review' ? '#C4B5FD' : '#FDBA74'}; font-family:'JetBrains Mono'">// ${data.mode}</h3>`;
            html += marked.parse(data.content);

            // CHECK TYPE: SELECTION vs INPUT
            if (data.type === 'input') {
                const safeExpl = encodeURIComponent(data.explanation || "").replace(/'/g, "%27");
                const safePhrase = (data.validation_phrase || "").replace(/'/g, "\\'");
                html += `
                    <div class="typing-container">
                        <input type="text" id="type-answer" class="typing-input" autocomplete="off" placeholder="Escribe la respuesta exacta..." onkeyup="checkInput(event, '${safePhrase}', '${safeExpl}')">
                        <div class="typing-hint">Presiona ENTER para validar.</div>
                    </div>
                `;
            } else if (data.options) {
                html += `<div style="margin-top:30px">`;
                data.options.forEach((opt, idx) => {
                    const char = String.fromCharCode(65 + idx);
                    const safeExpl = encodeURIComponent(data.explanation || "").replace(/'/g, "%27");
                    html += `<button class="option-btn" onclick="checkAnswer('${char}', '${data.correct_answer}', '${safeExpl}')">
                        <strong style="color:#FDBA74; margin-right:10px;">${char}</strong> ${opt}
                    </button>`;
                });
                html += `</div>`;
            }
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('study-modal').style.display = 'block';

            if (data.type === 'input') setTimeout(() => document.getElementById('type-answer').focus(), 100);
        }

        window.checkAnswer = function (sel, corr, expl) {
            if (sel === corr) {
                showSuccess(expl);
            } else {
                alert("‚ö†Ô∏è ALERTA COGNITIVA: Respuesta Incorrecta.");
            }
        }

        window.checkInput = function (e, phrase, expl) {
            if (e.key === 'Enter') {
                const input = e.target.value.trim().toLowerCase();
                const valid = phrase.trim().toLowerCase();
                if (input === valid) {
                    showSuccess(expl);
                } else {
                    e.target.style.borderColor = '#EF4444';
                    e.target.classList.add('shake');
                    setTimeout(() => e.target.classList.remove('shake'), 400);
                }
            }
        }

        function showSuccess(expl) {
            document.getElementById('modal-content').innerHTML = `
                <div style="text-align:center; padding:20px;">
                    <h1 style="font-size:4rem; margin:0">‚úÖ</h1>
                    <h2 style="color:#86EFAC">NEURONA REFORZADA</h2>
                    <div style="text-align:left; color:#E2E8F0; margin-top:30px; font-size:1rem; line-height:1.6; max-height:45vh; overflow-y:auto; padding-right:10px; border-left:3px solid #38BDF8; padding-left:14px; background:rgba(56,189,248,0.05); border-radius:0 8px 8px 0;">
                        ${marked.parse(decodeURIComponent(expl))}
                    </div>
                    <!-- SRS FEEDBACK BUTTONS -->
                    <div style="margin-top:40px; border-top:1px dashed #475569; padding-top:20px; text-align:center;">
                        <p style="color:#94A3B8; font-size:0.9rem; margin-bottom:15px;">¬øC√ìMO SENTISTE ESTE RETO?</p>
                        <div style="display:flex; gap:15px; justify-content:center;">
                            <button onclick="selectDifficulty('HARD')" style="flex:1; padding:15px; background:rgba(239, 68, 68, 0.2); border:1px solid #EF4444; color:#FCA5A5; border-radius:8px; cursor:pointer; font-weight:bold;">
                                DIF√çCIL (Repetir Ma√±ana)
                            </button>
                            <button onclick="selectDifficulty('EASY')" style="flex:1; padding:15px; background:rgba(134, 239, 172, 0.2); border:1px solid #86EFAC; color:#86EFAC; border-radius:8px; cursor:pointer; font-weight:bold;">
                                F√ÅCIL (Consolidado)
                            </button>
                        </div>
                    </div>
                </div>
            `;
            createParticles();
        }

        window.selectDifficulty = async function (level) {
            const currentLabel = document.getElementById('current-obj').innerText;
            const topic = currentLabel.replace('<b>', '').replace('</b>', '').trim();

            try {
                await fetch('/log_srs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topic, rating: level })
                });

                document.getElementById('modal-content').innerHTML = `
                    <div style="text-align:center; padding:40px;">
                        <h2 style="color:${level === 'HARD' ? '#EF4444' : '#86EFAC'}">SRS ACTUALIZADO</h2>
                        <div style="font-size:3rem; margin:20px;">üíæ</div>
                        <p style="color:#94A3B8; font-family:'JetBrains Mono'">
                            Algoritmo ajustado.<br>
                            Pr√≥xima repetici√≥n calculada.
                        </p>
                        <button onclick="goToNextTopic()" style="margin-top:30px; padding:18px 40px; background:#86EFAC; color:#020617; border:none; border-radius:12px; font-weight:bold; cursor:pointer; font-family:'JetBrains Mono'; font-size:1.1rem; box-shadow: 0 0 20px rgba(134, 239, 172, 0.4); transition: transform 0.2s;">
                            üöÄ CONTINUAR AL SIGUIENTE RETO
                        </button>
                    </div>
                `;
            } catch (e) {
                console.error(e);
                alert("Error guardando SRS. Revisa la consola.");
            }
        }

        window.goToNextTopic = async function () {
            try {
                const btn = document.querySelector('button[onclick="goToNextTopic()"]');
                btn.innerText = "üåÄ PROCESANDO NEURONAS...";
                btn.disabled = true;

                await fetch('/trigger_next', { method: 'POST' });

                document.getElementById('study-modal').style.display = 'none';
                // Trigger a refresh of the graph
                loadData();
                console.log("Continuando al siguiente tema...");
            } catch (e) {
                console.error(e);
                alert("Error al avanzar de tema.");
            }
        }

        function createParticles() {
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div');
                p.style.cssText = `position: fixed; top: 50 %; left: 50 %; width: 6px; height: 6px; background:#86EFAC; border - radius: 50 %; pointer - events: none; z - index: 999`;
                document.body.appendChild(p);
                const angle = Math.random() * Math.PI * 2;
                const dist = 100 + Math.random() * 200;
                p.animate([
                    { transform: `translate(0, 0) scale(1)`, opacity: 1 },
                    { transform: `translate(${Math.cos(angle) * dist}px, ${Math.sin(angle) * dist}px) scale(0)`, opacity: 0 }
                ], { duration: 1000 }).onfinish = () => p.remove();
            }
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') document.getElementById('study-modal').style.display = 'none';
        });

        initGraph();
    </script>
</body>

</html>